<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Hub Veille ‚Äî S√©curit√© Routi√®re</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --blue:#003189;--blue-light:#e8edf7;
  --red:#e1000f;--red-soft:#fde8ea;
  --white:#fff;--g0:#f5f6fa;--g1:#e8e9ef;--g2:#b0b3c6;--g3:#6b6f8a;--g4:#2d3050;
  --gold:#d4a017;--green:#00826b;--green-s:#d9f5f0;
  --sh:0 1px 3px rgba(0,49,137,.08),0 1px 2px rgba(0,49,137,.04);
  --shm:0 4px 16px rgba(0,49,137,.10),0 2px 6px rgba(0,49,137,.06);
  --shl:0 12px 40px rgba(0,49,137,.14);
  --r:6px;--rm:12px;--tr:.2s cubic-bezier(.4,0,.2,1);
  --f:'Inter',system-ui,sans-serif;
}
html{font-size:16px;scroll-behavior:smooth}
body{font-family:var(--f);background:var(--g0);color:var(--g4);min-height:100vh;line-height:1.6}
.topbar{background:var(--blue);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 2rem;height:46px;font-size:.76rem}
.tb-l{display:flex;align-items:center;gap:.9rem}
.flag{display:flex;gap:2px;overflow:hidden;border-radius:2px}
.flag span{display:block;width:10px;height:16px}
.fb{background:#002395}.fw{background:#fff}.fr{background:#ED2939}
.tb-brand{font-weight:600;letter-spacing:.01em}
.tb-r{opacity:.65;font-size:.7rem}
header{background:linear-gradient(135deg,#001a5e 0%,#002d85 45%,#0041a8 100%);color:#fff;padding:2.8rem 2rem 2.4rem;position:relative;overflow:hidden}
header::after{content:'';position:absolute;right:-80px;top:-80px;width:350px;height:350px;border-radius:50%;background:rgba(255,255,255,.03);pointer-events:none}
.hi{max-width:1280px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:2rem}
.hl{flex:1}
.eyebrow{display:inline-flex;align-items:center;gap:.42rem;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.18);border-radius:100px;padding:.24rem .82rem;font-size:.68rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;margin-bottom:.9rem}
.dot-live{width:7px;height:7px;background:#4ade80;border-radius:50%;animation:lp 2s ease-in-out infinite}
@keyframes lp{0%,100%{opacity:1}50%{opacity:.3}}
header h1{font-size:2rem;font-weight:700;line-height:1.15;margin-bottom:.65rem;letter-spacing:-.02em}
header h1 span{color:#93c5fd}
header p{font-size:.88rem;opacity:.8;max-width:480px;line-height:1.75}
.hstats{display:flex;gap:.9rem;margin-top:1.5rem;flex-wrap:wrap}
.spill{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.14);border-radius:10px;padding:.55rem 1rem;text-align:center}
.spill strong{display:block;font-size:1.4rem;font-weight:700}
.spill small{font-size:.64rem;opacity:.66;text-transform:uppercase;letter-spacing:.05em}
.hemb{flex-shrink:0;background:rgba(255,255,255,.09);border:1px solid rgba(255,255,255,.14);border-radius:var(--rm);padding:1.2rem 1.5rem;text-align:center;display:flex;flex-direction:column;align-items:center;gap:.55rem}
.eico{width:58px;height:58px;background:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.75rem}
.elbl{font-size:.66rem;opacity:.68;line-height:1.5;max-width:100px}
.navbar{background:var(--white);border-bottom:2px solid var(--g1);position:sticky;top:0;z-index:100;box-shadow:var(--sh)}
.ni{max-width:1280px;margin:0 auto;display:flex;align-items:center;gap:.32rem;padding:0 2rem;overflow-x:auto;scrollbar-width:none;height:52px}
.ni::-webkit-scrollbar{display:none}
.nb{flex-shrink:0;display:flex;align-items:center;gap:.4rem;padding:.4rem .92rem;border-radius:100px;border:none;background:transparent;font-family:var(--f);font-size:.81rem;font-weight:500;color:var(--g3);cursor:pointer;transition:var(--tr);white-space:nowrap}
.nb:hover{background:var(--g0);color:var(--blue)}
.nb.active{background:var(--blue);color:#fff}
.nc{border-radius:100px;padding:.04rem .4rem;font-size:.65rem;font-weight:700}
.nb.active .nc{background:rgba(255,255,255,.22)}
.nb:not(.active) .nc{background:var(--g1);color:var(--g3)}
main{max-width:1280px;margin:1.8rem auto;padding:0 2rem 5rem;display:grid;grid-template-columns:1fr 320px;gap:1.8rem;align-items:start}
@media(max-width:900px){
  main{grid-template-columns:1fr}
  .sidebar,.hemb{display:none}
  header{padding:2rem 1.2rem}
  header h1{font-size:1.5rem}
  main{padding:0 1rem 3rem;margin:1rem auto}
}
.toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.2rem;gap:.8rem;flex-wrap:wrap}
.tb-ll{display:flex;align-items:center;gap:.65rem}
.tb-title{font-size:1rem;font-weight:700;color:var(--g4)}
.tb-cnt{background:var(--blue-light);color:var(--blue);font-size:.72rem;font-weight:700;padding:.16rem .56rem;border-radius:100px}
.tb-rr{display:flex;gap:.48rem;align-items:center;flex-wrap:wrap}
.sw{position:relative}
.si{position:absolute;left:.76rem;top:50%;transform:translateY(-50%);color:var(--g2);font-size:.86rem;pointer-events:none}
.srch{padding:.48rem .88rem .48rem 2.2rem;border:1.5px solid var(--g1);border-radius:100px;font-family:var(--f);font-size:.81rem;color:var(--g4);background:var(--white);outline:none;width:220px;transition:var(--tr)}
.srch:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(0,49,137,.09);width:265px}
.btn{display:inline-flex;align-items:center;gap:.4rem;background:var(--blue);color:#fff;border:none;border-radius:100px;padding:.48rem 1.1rem;font-family:var(--f);font-size:.81rem;font-weight:700;cursor:pointer;transition:var(--tr);flex-shrink:0}
.btn:hover{background:#0041a8;transform:translateY(-1px);box-shadow:var(--shm)}
.btn:active{transform:translateY(0)}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
.spin{animation:sp 1s linear infinite;display:inline-block}
@keyframes sp{to{transform:rotate(360deg)}}
.cg{display:flex;flex-direction:column;gap:.9rem}
.card{background:var(--white);border-radius:var(--rm);border:1.5px solid var(--g1);padding:1.3rem 1.45rem 1.3rem 1.65rem;box-shadow:var(--sh);transition:var(--tr);position:relative;overflow:hidden;animation:fu .38s ease both}
.card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background:var(--blue);border-radius:4px 0 0 4px}
.card[data-cat="Campagne"]::before{background:var(--red)}
.card[data-cat="Statistiques"]::before{background:var(--green)}
.card[data-cat="R√©glementation"]::before{background:var(--gold)}
.card[data-cat="International"]::before{background:#7c3aed}
.card[data-cat="Pr√©vention"]::before{background:#0891b2}
.card:hover{box-shadow:var(--shm);border-color:var(--g2);transform:translateY(-2px)}
@keyframes fu{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.ctop{display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;margin-bottom:.68rem}
.bdgs{display:flex;align-items:center;gap:.4rem;flex-wrap:wrap}
.badge{display:inline-flex;align-items:center;gap:.25rem;font-size:.67rem;font-weight:700;padding:.17rem .6rem;border-radius:100px;text-transform:uppercase;letter-spacing:.04em}
.ba{background:var(--blue-light);color:var(--blue)}
.bc{background:var(--red-soft);color:var(--red)}
.bs{background:var(--green-s);color:var(--green)}
.br{background:#fef9c3;color:#92400e}
.bi{background:#ede9fe;color:#5b21b6}
.bp{background:#e0f2fe;color:#0369a1}
.bsrc{background:var(--g0);color:var(--g3);border:1px solid var(--g1);font-weight:500}
.cdt{font-size:.68rem;color:var(--g2);white-space:nowrap;margin-top:.06rem}
.cttl{font-size:.97rem;font-weight:700;color:var(--g4);margin-bottom:.5rem;line-height:1.4}
.csum{font-size:.85rem;color:var(--g3);line-height:1.7;margin-bottom:.88rem}
.cft{display:flex;align-items:center;justify-content:space-between;border-top:1px solid var(--g0);padding-top:.66rem;gap:1rem}
.sch{display:flex;align-items:center;gap:.36rem;font-size:.75rem;color:var(--g3)}
.sch strong{color:var(--g4);font-weight:600}
.rel{display:flex;align-items:center;gap:.26rem;font-size:.67rem;font-weight:700;margin-top:.2rem}
.rd{width:7px;height:7px;border-radius:50%}
.rh{color:var(--green)}.rh .rd{background:var(--green)}
.rm2{color:var(--gold)}.rm2 .rd{background:var(--gold)}
.clink{display:inline-flex;align-items:center;gap:.3rem;font-size:.77rem;font-weight:700;color:var(--blue);text-decoration:none;padding:.28rem .8rem;border-radius:100px;border:1.5px solid var(--blue-light);transition:var(--tr);white-space:nowrap}
.clink:hover{background:var(--blue);color:#fff;border-color:var(--blue)}
.clink.dis{opacity:.36;pointer-events:none}
.cf{background:linear-gradient(140deg,#001d6e 0%,var(--blue) 100%);color:#fff;border-color:var(--blue)}
.cf::before{background:rgba(255,255,255,.32)}
.cf .cttl{color:#fff;font-size:1.08rem}
.cf .csum{color:rgba(255,255,255,.8)}
.cf .cdt{color:rgba(255,255,255,.5)}
.cf .ba,.cf .bc,.cf .bs,.cf .br,.cf .bi,.cf .bp{background:rgba(255,255,255,.16);color:#fff}
.cf .bsrc{background:rgba(255,255,255,.1);color:rgba(255,255,255,.76);border-color:rgba(255,255,255,.16)}
.cf .cft{border-color:rgba(255,255,255,.13)}
.cf .sch{color:rgba(255,255,255,.65)}.cf .sch strong{color:#fff}
.cf .clink{color:#fff;border-color:rgba(255,255,255,.26)}.cf .clink:hover{background:rgba(255,255,255,.18)}
.cf .rh{color:#86efac}.cf .rh .rd{background:#4ade80}
.fbadge{display:inline-flex;align-items:center;gap:.3rem;background:rgba(255,255,255,.17);border:1px solid rgba(255,255,255,.26);border-radius:100px;padding:.17rem .65rem;font-size:.66rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;margin-bottom:.6rem}
.sk{background:linear-gradient(90deg,var(--g1) 25%,#eff0f5 50%,var(--g1) 75%);background-size:200% 100%;animation:sh 1.5s infinite;border-radius:6px}
@keyframes sh{to{background-position:-200% 0}}
.skc{background:var(--white);border-radius:var(--rm);border:1.5px solid var(--g1);padding:1.3rem 1.45rem}
.lwrap{display:flex;flex-direction:column;align-items:center;padding:2rem;gap:.8rem}
.dots{display:flex;gap:.36rem}
.dots span{width:9px;height:9px;background:var(--blue);border-radius:50%;animation:dt .9s ease-in-out infinite}
.dots span:nth-child(2){animation-delay:.18s}.dots span:nth-child(3){animation-delay:.36s}
@keyframes dt{0%,80%,100%{transform:scale(.65);opacity:.28}40%{transform:scale(1.2);opacity:1}}
.lmsg{font-size:.85rem;color:var(--g3)}
.empty{text-align:center;padding:4rem 2rem}
.ei{font-size:3rem;opacity:.3;margin-bottom:.9rem}
.et{font-size:.97rem;font-weight:700;color:var(--g4);margin-bottom:.4rem}
.es{font-size:.82rem;color:var(--g3)}
.err{background:#fef2f2;border:1.5px solid #fca5a5;border-radius:var(--r);padding:1rem 1.2rem;color:#991b1b;font-size:.82rem;margin-bottom:1rem;line-height:1.65}
.apn{background:linear-gradient(135deg,#fffbeb,#fef3c7);border:1.5px solid #f59e0b;border-radius:var(--rm);padding:1.25rem 1.45rem;margin-bottom:1.35rem}
.apn h3{font-size:.92rem;font-weight:700;color:#92400e;margin-bottom:.42rem}
.apn p{font-size:.79rem;color:#78350f;margin-bottom:.85rem;line-height:1.65}
.apr{display:flex;gap:.46rem}
.api-in{flex:1;padding:.46rem .86rem;border:1.5px solid #f59e0b;border-radius:var(--r);font-family:var(--f);font-size:.81rem;outline:none;background:#fff}
.api-in:focus{border-color:#d97706;box-shadow:0 0 0 3px rgba(217,119,6,.12)}
.api-btn{padding:.46rem 1rem;background:#d97706;color:#fff;border:none;border-radius:var(--r);font-family:var(--f);font-size:.81rem;font-weight:700;cursor:pointer;transition:var(--tr)}
.api-btn:hover{background:#b45309}
.sidebar{display:flex;flex-direction:column;gap:1.1rem}
.widget{background:var(--white);border-radius:var(--rm);border:1.5px solid var(--g1);overflow:hidden;box-shadow:var(--sh)}
.wh{padding:.8rem 1.1rem;background:var(--g0);border-bottom:1px solid var(--g1);font-size:.7rem;font-weight:700;color:var(--g4);text-transform:uppercase;letter-spacing:.07em;display:flex;align-items:center;gap:.4em}
.wb{padding:.92rem 1.1rem}
.sl{list-style:none}
.sl li{display:flex;align-items:center;justify-content:space-between;padding:.46rem 0;border-bottom:1px solid var(--g0);font-size:.77rem}
.sl li:last-child{border:none}
.sn{font-weight:500;color:var(--g4);display:flex;align-items:center;gap:.36rem}
.sdot{width:6px;height:6px;border-radius:50%;background:var(--green);flex-shrink:0}
.stag{font-size:.63rem;padding:.09rem .38rem;border-radius:100px;background:var(--g0);color:var(--g3);border:1px solid var(--g1);font-weight:500}
.swg{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
.swb{background:var(--g0);border-radius:var(--r);padding:.65rem .8rem;text-align:center}
.swv{font-size:1.42rem;font-weight:700;color:var(--blue)}
.swl{font-size:.65rem;color:var(--g3);margin-top:.07rem}
.wfoot{padding:.56rem 1.1rem;background:var(--g0);border-top:1px solid var(--g1);font-size:.7rem;color:var(--g3);display:flex;align-items:center;gap:.36rem}
.wfd{width:6px;height:6px;border-radius:50%;background:var(--green)}
.disc{background:#fffbeb;border:1px solid #fde68a;border-radius:var(--r);padding:.86rem .98rem;font-size:.73rem;color:#92400e;line-height:1.65}
.disc strong{display:block;margin-bottom:.26rem}
footer{background:var(--g4);color:rgba(255,255,255,.56);text-align:center;padding:1.4rem 2rem;font-size:.73rem;line-height:1.9}
footer strong{color:rgba(255,255,255,.9)}
.toast{position:fixed;bottom:2rem;right:2rem;background:var(--g4);color:#fff;padding:.7rem 1.1rem;border-radius:var(--r);font-size:.81rem;font-weight:500;box-shadow:var(--shl);z-index:9999;animation:fu .3s ease;max-width:320px}
</style>
</head>
<body>

<div class="topbar">
  <div class="tb-l">
    <div class="flag"><span class="fb"></span><span class="fw"></span><span class="fr"></span></div>
    <span class="tb-brand">D√©l√©gation √† la S√©curit√© Routi√®re ‚Äî Outil de Veille Informationnelle</span>
  </div>
  <div class="tb-r">Usage interne ¬∑ Confidentiel</div>
</div>

<header>
  <div class="hi">
    <div class="hl">
      <div class="eyebrow"><span class="dot-live"></span>Veille active ‚Äî Temps r√©el</div>
      <h1>Hub S√©curit√©<br/><span>Routi√®re</span></h1>
      <p>Agr√©gation intelligente des actualit√©s, campagnes et donn√©es officielles. Sources institutionnelles uniquement ‚Äî droits d'auteur respect√©s, sources toujours cit√©es.</p>
      <div class="hstats">
        <div class="spill"><strong>12+</strong><small>Sources</small></div>
        <div class="spill"><strong id="art-count">0</strong><small>Articles</small></div>
        <div class="spill"><strong id="last-sync">‚Äî</strong><small>Synchro</small></div>
      </div>
    </div>
    <div class="hemb">
      <div class="eico">üõ°Ô∏è</div>
      <div class="elbl">D√©l√©gation √† la S√©curit√© Routi√®re</div>
    </div>
  </div>
</header>

<nav class="navbar">
  <div class="ni">
    <button class="nb active" onclick="filterCat('Tous')" id="nav-tous">üóÇ Tous <span class="nc" id="nc-tous">0</span></button>
    <button class="nb" onclick="filterCat('Actualit√©')" id="nav-actu">üì∞ Actualit√© <span class="nc" id="nc-actu">0</span></button>
    <button class="nb" onclick="filterCat('Campagne')" id="nav-camp">üì¢ Campagnes <span class="nc" id="nc-camp">0</span></button>
    <button class="nb" onclick="filterCat('Statistiques')" id="nav-stat">üìä Statistiques <span class="nc" id="nc-stat">0</span></button>
    <button class="nb" onclick="filterCat('R√©glementation')" id="nav-regl">‚öñÔ∏è R√©glementation <span class="nc" id="nc-regl">0</span></button>
    <button class="nb" onclick="filterCat('Pr√©vention')" id="nav-prev">üéó Pr√©vention <span class="nc" id="nc-prev">0</span></button>
    <button class="nb" onclick="filterCat('International')" id="nav-intl">üåç International <span class="nc" id="nc-intl">0</span></button>
  </div>
</nav>

<main>
  <section>
    <div class="apn" id="apiNotice">
      <h3>üîë Cl√© API Anthropic requise</h3>
      <p>Ce hub utilise Claude AI + recherche web en temps r√©el. Saisissez votre cl√© API Anthropic pour activer la collecte automatique d'actualit√©s v√©rifi√©es. Elle sera m√©moris√©e dans votre navigateur.</p>
      <div class="apr">
        <input type="password" id="apiKeyInput" class="api-in" placeholder="sk-ant-api03-..."/>
        <button class="api-btn" onclick="saveApiKey()">‚úì Activer</button>
      </div>
    </div>

    <div class="toolbar">
      <div class="tb-ll">
        <span class="tb-title" id="toolbar-title">Fil d'information</span>
        <span class="tb-cnt" id="toolbar-count">0 article(s)</span>
      </div>
      <div class="tb-rr">
        <div class="sw">
          <span class="si">üîç</span>
          <input type="text" id="searchInput" class="srch" placeholder="Rechercher‚Ä¶" oninput="filterSearch()"/>
        </div>
        <button class="btn" id="fetchBtn" onclick="fetchNews()">‚ö° Actualiser le fil</button>
      </div>
    </div>

    <div id="contentArea">
      <div class="empty">
        <div class="ei">üì°</div>
        <div class="et">Hub pr√™t √† collecter</div>
        <div class="es">Entrez votre cl√© API puis cliquez sur <strong>Actualiser le fil</strong></div>
      </div>
    </div>
  </section>

  <aside class="sidebar">
    <div class="widget">
      <div class="wh">üìå Sources r√©f√©renc√©es</div>
      <div class="wb">
        <ul class="sl">
          <li><span class="sn"><span class="sdot"></span>securite-routiere.gouv.fr</span><span class="stag">Officiel</span></li>
          <li><span class="sn"><span class="sdot"></span>ONISR</span><span class="stag">Stats</span></li>
          <li><span class="sn"><span class="sdot"></span>Pr√©vention Routi√®re</span><span class="stag">ONG</span></li>
          <li><span class="sn"><span class="sdot"></span>Legifrance</span><span class="stag">Juridique</span></li>
          <li><span class="sn"><span class="sdot" style="background:#7c3aed"></span>WHO / OMS</span><span class="stag">Intl</span></li>
          <li><span class="sn"><span class="sdot" style="background:#0891b2"></span>ETSC Europe</span><span class="stag">EU</span></li>
          <li><span class="sn"><span class="sdot"></span>Cerema</span><span class="stag">Technique</span></li>
          <li><span class="sn"><span class="sdot"></span>AFP / France Info</span><span class="stag">Presse</span></li>
        </ul>
      </div>
      <div class="wfoot"><span class="wfd"></span>Sources institutionnelles uniquement</div>
    </div>

    <div class="widget">
      <div class="wh">üìà Tableau de bord</div>
      <div class="wb">
        <div class="swg">
          <div class="swb"><div class="swv" id="sw-actu">0</div><div class="swl">Actualit√©s</div></div>
          <div class="swb"><div class="swv" id="sw-camp" style="color:var(--red)">0</div><div class="swl">Campagnes</div></div>
          <div class="swb"><div class="swv" id="sw-stat" style="color:var(--green)">0</div><div class="swl">Statistiques</div></div>
          <div class="swb"><div class="swv" id="sw-regl" style="color:var(--gold)">0</div><div class="swl">R√©glementation</div></div>
        </div>
      </div>
    </div>

    <div class="disc">
      <strong>‚öñÔ∏è Politique √©ditoriale</strong>
      Extraits courts uniquement ¬∑ Lien source syst√©matique ¬∑ Aucune donn√©e invent√©e ¬∑ Sources non v√©rifi√©es exclues automatiquement
    </div>

    <div class="widget">
      <div class="wh">ü§ñ Moteur IA</div>
      <div class="wb" style="font-size:.74rem;color:var(--g3);line-height:1.78">
        Propuls√© par <strong style="color:var(--g4)">Claude (Anthropic)</strong> avec recherche web temps r√©el.<br/><br/>
        Classification th√©matique, √©valuation de fiabilit√© et r√©sum√© √©ditorial g√©n√©r√©s automatiquement.<br/><br/>
        <div style="display:flex;flex-direction:column;gap:.26rem">
          <span style="color:var(--green);font-weight:600">‚úì Droits d'auteur respect√©s</span>
          <span style="color:var(--green);font-weight:600">‚úì Source originale cit√©e</span>
          <span style="color:var(--green);font-weight:600">‚úì Extraits courts uniquement</span>
          <span style="color:var(--green);font-weight:600">‚úì Aucune donn√©e invent√©e</span>
        </div>
      </div>
    </div>
  </aside>
</main>

<footer>
  <strong>Hub Veille S√©curit√© Routi√®re</strong> ‚Äî Usage interne<br/>
  D√©l√©gation √† la S√©curit√© Routi√®re ¬∑ Propuls√© par Claude AI + Recherche Web en temps r√©el<br/>
  R√©sum√©s √©ditoriaux courts ¬∑ Lien source syst√©matique ¬∑ Droits d'auteur respect√©s
</footer>

<script>
let API_KEY = '';
let allArticles = [];
let currentCat = 'Tous';
const today = new Date().toLocaleDateString('fr-FR', {day:'numeric', month:'long', year:'numeric'});

function saveApiKey() {
  const v = document.getElementById('apiKeyInput').value.trim();
  if (!v.startsWith('sk-ant-')) { toast('‚ö†Ô∏è Cl√© invalide ‚Äî elle doit commencer par sk-ant-'); return; }
  API_KEY = v;
  try { localStorage.setItem('dsr_hub_key', v); } catch(e) {}
  document.getElementById('apiNotice').style.display = 'none';
  toast('‚úÖ Cl√© activ√©e ‚Äî hub op√©rationnel');
}

(function init() {
  try {
    const k = localStorage.getItem('dsr_hub_key');
    if (k) { API_KEY = k; document.getElementById('apiKeyInput').value = k; }
    if (k && k.startsWith('sk-ant-')) document.getElementById('apiNotice').style.display = 'none';
  } catch(e) {}
  document.getElementById('last-sync').textContent = 'Jamais';
})();

async function fetchNews() {
  if (!API_KEY || !API_KEY.startsWith('sk-ant-')) {
    document.getElementById('apiNotice').style.display = 'block';
    toast('‚ö†Ô∏è Cl√© API requise'); return;
  }
  const btn = document.getElementById('fetchBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spin">‚ü≥</span> Collecte en cours‚Ä¶';
  showSkeleton();

  const systemPrompt = `Tu es un assistant de veille sp√©cialis√© en s√©curit√© routi√®re pour la D√©l√©gation √† la S√©curit√© Routi√®re (DSR) fran√ßaise.
MISSION : Rechercher et synth√©tiser les actualit√©s r√©centes et fiables en s√©curit√© routi√®re.
SOURCES ACCEPT√âES UNIQUEMENT :
- Officielles fran√ßaises : securite-routiere.gouv.fr, interieur.gouv.fr, ONISR, Legifrance, CEREMA, Bison Fut√©
- Associatives : Pr√©vention Routi√®re, MAIF Pr√©vention, AXA Pr√©vention, Ligue contre la Violence Routi√®re
- EU/International : ETSC, Commission Europ√©enne, OMS/WHO, IRTAD
- Presse de r√©f√©rence : Le Monde, AFP, France Info, Le Figaro, RTL, L'Obs
R√àGLES ABSOLUES :
1. Ne jamais inventer de donn√©es, statistiques ou URLs
2. Ne jamais reproduire plus de 2 phrases d'un article source
3. Toujours fournir l'URL r√©elle et v√©rifiable de la source
4. Exclure : blogs personnels, forums, r√©seaux sociaux non institutionnels
5. √âvaluer la fiabilit√© : "haute" (source officielle) ou "moyenne" (presse)
CAT√âGORIES : Actualit√©, Campagne, Statistiques, R√©glementation, Pr√©vention, International
RETOURNE UNIQUEMENT un JSON valide, sans texte avant ni apr√®s, sans backticks :
{"articles":[{"id":"a1","titre":"...","categorie":"Actualit√©","source":"Nom","source_url":"https://url.fr","date":"15 f√©vrier 2026","resume":"2-3 phrases max.","fiabilite":"haute","featured":false}]}`;

  const userPrompt = `Effectue une recherche web sur l'actualit√© r√©cente en s√©curit√© routi√®re. Date du jour : ${today}.
Th√®mes : bilan accidentalit√© ONISR, campagnes en cours, √©volutions l√©gislatives, technologies routi√®res, actualit√©s ETSC/OMS.
Retourne 8 √† 12 articles fiables et r√©cents. Marque featured:true pour le plus important.`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': API_KEY,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-5-20250929',
        max_tokens: 4096,
        system: systemPrompt,
        tools: [{ type: 'web_search_20250305', name: 'web_search' }],
        messages: [{ role: 'user', content: userPrompt }]
      })
    });
    if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error(e.error?.message || `Erreur HTTP ${res.status}`); }
    const data = await res.json();
    const text = (data.content || []).filter(b => b.type === 'text').map(b => b.text).join('');
    const m = text.match(/\{[\s\S]*"articles"[\s\S]*\}/);
    if (!m) throw new Error('Aucun JSON trouv√© dans la r√©ponse');
    const parsed = JSON.parse(m[0]);
    if (!Array.isArray(parsed.articles)) throw new Error('Format de r√©ponse invalide');
    allArticles = parsed.articles;
    renderArticles();
    updateCounts();
    const hm = new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
    document.getElementById('last-sync').textContent = hm;
    document.getElementById('art-count').textContent = allArticles.length;
    toast(`‚úÖ ${allArticles.length} articles collect√©s ¬∑ ${hm}`);
  } catch(err) {
    document.getElementById('contentArea').innerHTML = `
      <div class="err"><strong>‚ùå Erreur de collecte</strong><br/>${esc(err.message)}<br/><br/>V√©rifiez votre cl√© API et r√©essayez.</div>
      <div class="empty"><div class="ei">‚ö†Ô∏è</div><div class="et">Connexion interrompue</div><div class="es">Cliquez sur Actualiser pour r√©essayer</div></div>`;
    console.error(err);
  } finally {
    btn.disabled = false;
    btn.innerHTML = '‚ö° Actualiser le fil';
  }
}

function renderArticles() {
  const q = (document.getElementById('searchInput').value || '').toLowerCase();
  let arts = allArticles;
  if (currentCat !== 'Tous') arts = arts.filter(a => a.categorie === currentCat);
  if (q) arts = arts.filter(a => [(a.titre||''),(a.resume||''),(a.source||'')].join(' ').toLowerCase().includes(q));
  document.getElementById('toolbar-count').textContent = `${arts.length} article(s)`;
  document.getElementById('toolbar-title').textContent = currentCat === 'Tous' ? "Fil d'information" : currentCat;
  const area = document.getElementById('contentArea');
  if (!arts.length) {
    area.innerHTML = '<div class="empty"><div class="ei">üîç</div><div class="et">Aucun r√©sultat</div><div class="es">Modifiez votre recherche ou changez de cat√©gorie</div></div>';
    return;
  }
  const sorted = [...arts.filter(a => a.featured), ...arts.filter(a => !a.featured)];
  area.innerHTML = `<div class="cg">${sorted.map((a,i) => cardHTML(a, i===0 && !!a.featured)).join('')}</div>`;
}

const CAT_BADGE = {Actualit√©:'ba',Campagne:'bc',Statistiques:'bs',R√©glementation:'br',International:'bi',Pr√©vention:'bp'};
const CAT_ICON  = {Actualit√©:'üì∞',Campagne:'üì¢',Statistiques:'üìä',R√©glementation:'‚öñÔ∏è',International:'üåç',Pr√©vention:'üéó'};

function cardHTML(a, feat) {
  const bcls = CAT_BADGE[a.categorie] || 'ba';
  const bico = CAT_ICON[a.categorie]  || 'üìå';
  const relHTML = a.fiabilite === 'haute'
    ? '<div class="rel rh"><span class="rd"></span>Source fiable</div>'
    : '<div class="rel rm2"><span class="rd"></span>√Ä v√©rifier</div>';
  const hasUrl = (a.source_url || '').startsWith('http');
  return `<div class="card ${feat?'cf':''}" data-cat="${esc(a.categorie)}">
  ${feat ? '<div class="fbadge">‚≠ê √Ä la une</div>' : ''}
  <div class="ctop">
    <div class="bdgs">
      <span class="badge ${bcls}">${bico} ${esc(a.categorie)}</span>
      <span class="badge bsrc">${esc(a.source)}</span>
    </div>
    <span class="cdt">${esc(a.date || today)}</span>
  </div>
  <div class="cttl">${esc(a.titre)}</div>
  <div class="csum">${esc(a.resume)}</div>
  <div class="cft">
    <div style="display:flex;flex-direction:column;gap:.26rem">
      <div class="sch">üîó <strong>${esc(a.source)}</strong></div>
      ${relHTML}
    </div>
    ${hasUrl ? `<a href="${esc(a.source_url)}" target="_blank" rel="noopener noreferrer" class="clink">Lire l'article ‚Üí</a>` : '<span class="clink dis">Source non dispo</span>'}
  </div>
</div>`;
}

function filterCat(cat) {
  currentCat = cat;
  document.querySelectorAll('.nb').forEach(b => b.classList.remove('active'));
  const map = {Tous:'tous',Actualit√©:'actu',Campagne:'camp',Statistiques:'stat',R√©glementation:'regl',Pr√©vention:'prev',International:'intl'};
  const el = document.getElementById('nav-' + (map[cat] || 'tous'));
  if (el) el.classList.add('active');
  if (allArticles.length) renderArticles();
}

function filterSearch() { if (allArticles.length) renderArticles(); }

function updateCounts() {
  const c = cat => allArticles.filter(a => a.categorie === cat).length;
  document.getElementById('nc-tous').textContent = allArticles.length;
  document.getElementById('nc-actu').textContent = c('Actualit√©');
  document.getElementById('nc-camp').textContent = c('Campagne');
  document.getElementById('nc-stat').textContent = c('Statistiques');
  document.getElementById('nc-regl').textContent = c('R√©glementation');
  document.getElementById('nc-prev').textContent = c('Pr√©vention');
  document.getElementById('nc-intl').textContent = c('International');
  document.getElementById('sw-actu').textContent = c('Actualit√©');
  document.getElementById('sw-camp').textContent = c('Campagne');
  document.getElementById('sw-stat').textContent = c('Statistiques');
  document.getElementById('sw-regl').textContent = c('R√©glementation');
}

function showSkeleton() {
  const sk = d => `<div class="skc" style="animation-delay:${d}s">
  <div style="display:flex;gap:.5rem;margin-bottom:.82rem">
    <div class="sk" style="width:27%;height:20px;border-radius:100px"></div>
    <div class="sk" style="width:19%;height:20px;border-radius:100px"></div>
  </div>
  <div class="sk" style="width:80%;height:18px;margin-bottom:.55rem"></div>
  <div class="sk" style="width:56%;height:12px;margin-bottom:.35rem"></div>
  <div class="sk" style="width:72%;height:12px;margin-bottom:.35rem"></div>
  <div class="sk" style="width:41%;height:12px"></div>
</div>`;
  document.getElementById('contentArea').innerHTML = `
<div class="lwrap">
  <div class="dots"><span></span><span></span><span></span></div>
  <div class="lmsg">üîç Recherche en cours sur les sources officielles‚Ä¶</div>
</div>
<div class="cg">${[0,0.07,0.14,0.21].map(sk).join('')}</div>`;
}

function esc(s) {
  return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function toast(msg) {
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => { t.style.cssText += 'opacity:0;transition:opacity .3s'; setTimeout(() => t.remove(), 300); }, 3200);
}
</script>
</body>
</html>
